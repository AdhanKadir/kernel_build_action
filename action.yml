name: 'Android Kernel Build Action'
description: "An action to build android kernel."
# Updated description for pull request demo

branding:
  icon: 'activity'
  color: 'blue'

inputs:
  kernel-url:
    description: 'URL of the Android kernel source repository'
    required: true
  kernel-branch:
    description: 'Branch name of the main kernel source repository'
    required: false
    default: main
  kernel-dir:
    description: 'Directory name for storing kernel source code'
    required: false
    default: kernel
  depth:
    description: 'Git clone depth for faster downloads'
    required: false
    default: '1'
  config:
    description: 'Name of the kernel configuration file to use'
    required: true
    default: defconfig
  arch:
    description: 'Target CPU architecture for cross-compilation'
    required: true
    default: arm64
  android-version:
    description: 'Android version for AOSP toolchain selection'
    required: false
    default: ''
  ndk-version:
    description: 'Android NDK version installed via sdkmanager when using AOSP Clang'
    required: false
    default: '26.1.10909125'
  vendor:
    description: 'Enable vendor kernel source code integration'
    required: false
    default: 'false'
  vendor-url:
    description: 'URL of the vendor kernel source repository'
    required: false
  vendor-branch:
    description: 'Branch name of the vendor kernel source repository'
    required: false
    default: main
  vendor-dir:
    description: 'Directory name for storing vendor kernel source'
    required: false
    default: vendor
  aosp-clang:
    description: 'Use AOSP Clang toolchain'
    required: false
    default: 'false'
  aosp-clang-version:
    description: 'Version of AOSP Clang toolchain to use'
    required: false
    default: r383902
  aosp-gcc:
    description: 'Use AOSP GCC toolchain'
    required: false
    default: 'false'
  other-clang-url:
    description: 'URL of custom Clang toolchain'
    required: false
  other-clang-branch:
    description: 'Branch of the custom Clang toolchain'
    required: false
    default: main
  other-gcc64-url:
    description: 'URL of custom 64-bit GCC toolchain'
    required: false
  other-gcc64-branch:
    description: 'Branch of custom 64-bit GCC toolchain'
    required: false
    default: main
  other-gcc32-url:
    description: 'URL of custom 32-bit GCC toolchain'
    required: false
  other-gcc32-branch:
    description: 'Branch of custom 32-bit GCC toolchain'
    required: false
    default: main
  ksu:
    description: 'Enable KernelSU integration'
    required: false
    default: 'false'
  ksu-version:
    description: 'Version of KernelSU to integrate'
    required: false
    default: main
  ksu-lkm:
    description: 'Build KernelSU as a loadable kernel module'
    required: false
    default: 'false'
  ksu-other:
    description: 'Use a third-party KernelSU fork'
    required: false
    default: 'false'
  ksu-url:
    description: 'URL of the third-party KernelSU fork'
    required: false
  rekernel:
    description: 'Enable Re-Kernel support'
    required: false
    default: 'false'
  nethunter:
    description: 'Enable Kali NetHunter support'
    required: false
    default: 'false'
  nethunter-patch:
    description: 'Apply NetHunter-specific patches'
    required: false
    default: 'false'
  lxc:
    description: 'Enable LXC/Docker container support'
    required: false
    default: 'false'
  lxc-patch:
    description: 'Apply LXC-specific patches'
    required: false
    default: 'false'
  kvm:
    description: 'Enable KVM (Kernel Virtual Machine) support'
    required: false
    default: 'false'
  bbg:
    description: 'Enable BaseBandGuard support'
    required: false
    default: 'false'
  khack:
    description: 'Integrate Kernel Driver Hack (khack) driver into the kernel'
    required: false
    default: 'false'
  khack-url:
    description: 'Repository URL containing the khack driver sources'
    required: false
  khack-branch:
    description: 'Branch or tag of the khack driver repository'
    required: false
    default: main
  khack-config:
    description: 'Value to set for CONFIG_KERNEL_HACK (y/m)'
    required: false
    default: y
  disable-lto:
    description: 'Disable Link Time Optimization (LTO)'
    required: false
    default: 'false'
  ccache:
    description: 'Enable ccache compilation cache'
    required: false
    default: 'false'
  anykernel3:
    description: 'Use AnyKernel3 packaging method'
    required: false
    default: 'false'
  anykernel3-url:
    description: 'URL of custom AnyKernel3 repository'
    required: false
  bootimg-url:
    description: 'URL to download the original boot.img file'
    required: false
  release:
    description: 'Automatically create a GitHub Release'
    required: false
    default: 'false'
  access-token:
    description: 'GitHub personal access token for releases'
    required: false
  extra-make-args:
    description: 'Additional make arguments in JSON array format'
    required: false
    default: '[]'

runs:
  using: 'composite'
  steps:

    - name: Setup ccache
      if: inputs.ccache == 'true'
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        key: ${{ inputs.config }}-0cb68f9cbcbb3de9c966cf66ed51471fbe51419e
        max-size: 4G
        create-symlink: true

    - name: Build Kernel
      shell: bash
      env:
        INPUT_KERNEL_URL: ${{ inputs.kernel-url }}
        INPUT_KERNEL_BRANCH: ${{ inputs.kernel-branch }}
        INPUT_KERNEL_DIR: ${{ inputs.kernel-dir }}
        INPUT_DEPTH: ${{ inputs.depth }}
        INPUT_CONFIG: ${{ inputs.config }}
        INPUT_ARCH: ${{ inputs.arch }}
        INPUT_ANDROID_VERSION: ${{ inputs.android-version }}
        INPUT_VENDOR: ${{ inputs.vendor }}
        INPUT_VENDOR_URL: ${{ inputs.vendor-url }}
        INPUT_VENDOR_BRANCH: ${{ inputs.vendor-branch }}
        INPUT_VENDOR_DIR: ${{ inputs.vendor-dir }}
        INPUT_AOSP_CLANG: ${{ inputs.aosp-clang }}
        INPUT_AOSP_CLANG_VERSION: ${{ inputs.aosp-clang-version }}
        INPUT_AOSP_GCC: ${{ inputs.aosp-gcc }}
        INPUT_OTHER_CLANG_URL: ${{ inputs.other-clang-url }}
        INPUT_OTHER_CLANG_BRANCH: ${{ inputs.other-clang-branch }}
        INPUT_OTHER_GCC64_URL: ${{ inputs.other-gcc64-url }}
        INPUT_OTHER_GCC64_BRANCH: ${{ inputs.other-gcc64-branch }}
        INPUT_OTHER_GCC32_URL: ${{ inputs.other-gcc32-url }}
        INPUT_OTHER_GCC32_BRANCH: ${{ inputs.other-gcc32-branch }}
        INPUT_KSU: ${{ inputs.ksu }}
        INPUT_KSU_VERSION: ${{ inputs.ksu-version }}
        INPUT_KSU_LKM: ${{ inputs.ksu-lkm }}
        INPUT_KSU_OTHER: ${{ inputs.ksu-other }}
        INPUT_KSU_URL: ${{ inputs.ksu-url }}
        INPUT_REKERNEL: ${{ inputs.rekernel }}
        INPUT_NETHUNTER: ${{ inputs.nethunter }}
        INPUT_NETHUNTER_PATCH: ${{ inputs.nethunter-patch }}
        INPUT_LXC: ${{ inputs.lxc }}
        INPUT_LXC_PATCH: ${{ inputs.lxc-patch }}
        INPUT_KVM: ${{ inputs.kvm }}
        INPUT_BBG: ${{ inputs.bbg }}
        INPUT_KHACK: ${{ inputs.khack }}
        INPUT_KHACK_URL: ${{ inputs.khack-url }}
        INPUT_KHACK_BRANCH: ${{ inputs.khack-branch }}
        INPUT_KHACK_CONFIG: ${{ inputs.khack-config }}
        INPUT_DISABLE_LTO: ${{ inputs.disable-lto }}
        INPUT_CCACHE: ${{ inputs.ccache }}
        INPUT_ANYKERNEL3: ${{ inputs.anykernel3 }}
        INPUT_ANYKERNEL3_URL: ${{ inputs.anykernel3-url }}
        INPUT_BOOTIMG_URL: ${{ inputs.bootimg-url }}
        INPUT_RELEASE: ${{ inputs.release }}
        INPUT_ACCESS_TOKEN: ${{ inputs.access-token }}
        INPUT_EXTRA_MAKE_ARGS: ${{ inputs.extra-make-args }}
        INPUT_NDK_VERSION: ${{ inputs.ndk-version }}
        GITHUB_EVENT_REPOSITORY_UPDATED_AT: ${{ github.event.repository.updated_at || '' }}
      run: $GITHUB_ACTION_PATH/scripts/build_kernel.sh

    - id: analyze
      if: failure()
      shell: bash
      run: |
         set +e
         python3 "${{ github.action_path }}/error.py" "kernel/${{ inputs.kernel-dir }}/out/build.log"

    - id: uploadi
      if: ${{ inputs.release == 'false' && inputs.anykernel3 == 'false' }}
      uses: actions/upload-artifact@v6
      with:
        name: kernel-built-bootimg
        path: build/*
        if-no-files-found: error
        overwrite: true

    - id: uploada
      if: ${{ inputs.release == 'false' && inputs.anykernel3 == 'true' }}
      uses: actions/upload-artifact@v6
      with:
        name: Anykernel3-flasher
        path: build/*
        if-no-files-found: error
        overwrite: true

    - id: release
      if: inputs.release == 'true'
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ inputs.access-token }}
      with:
        name: Last CI build kernel
        tag_name: last-ci-${{ github.sha }}
        files: build/*
        make_latest: true
        body: |
          Build Information:
          - Config: ${{ inputs.config }}
          - Branch: ${{ inputs.kernel-branch }}
          - Source: ${{ inputs.kernel-url }}
          - Architecture: ${{ inputs.arch }}

          Features:
          - KernelSU: ${{ inputs.ksu }}
          - NetHunter: ${{ inputs.nethunter }}
          - LXC: ${{ inputs.lxc }}
          - KVM: ${{ inputs.kvm }}
          - Rekernel: ${{ inputs.rekernel }}

          Build Details:
          - Timestamp: ${{ github.event.repository.updated_at }}
          - Workflow: ${{ github.workflow }}
          - Run ID: ${{ github.run_id }}
          - Commit: ${{ github.sha }}
